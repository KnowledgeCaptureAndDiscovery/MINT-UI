<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="mint-common-styles.html">

<link rel="import" href="../bower_components/mint-map/mint-map.html">
<link rel="import" href="mint-ajax.html">
<link rel="import" href="variable-graph.html">

<dom-module id="mint-results-detail">

  <template>
    <style include="mint-common-styles">

      :host {
        display: block;
      }

      .smooth {
        transition: opacity 0.4s;
        opacity: 0;
      }

      .smooth[has-content] {
        opacity: 1;
      }

      .detail {
        width: 90%;
        max-width: 1440px;
        margin:0 auto;
        margin-bottom: 5px;
      }

      .left {
        width: 40%;
      }
      .right {
        width: 60%;
      }
      .map {
        border: 2px solid var(--app-primary-color);
        border-radius: 4px;
        margin: 5px 0px;
      }

      .content {
        @apply(--layout-horizontal);
      }

      mint-map {
        width: 100%;
        height: 100%;
      }

      .outer {
        width:100%;
        height: 700px;
        overflow: auto;
        border: 2px solid var(--app-accent-color);
        border-width:0px 2px;
      }
      .toolbar {
        color:white;
        width:100%;
        background-color: var(--app-accent-color);
        border: 2px solid var(--app-accent-color);
        border-radius: 0px 4px 0px 0px;
        @apply --layout-horizontal;
        @apply --layout-no-wrap;
        @apply --layout-center-justified;
      }
      .toolbar paper-button, .toolbar paper-icon-button {
        max-height: 36px;
        color: white;
      }
      .bottom {
        border-radius: 0px 0px 4px 0px;
      }
      .toolbar paper-button {
        min-width:32px;
      }

      @media (max-width: 767px) {
        .left, .right {
          width: 100%;
        }
        .content {
          @apply(--layout-vertical);
          @apply(--layout-center);
        }

        .detail {
          box-sizing: border-box;
          margin: 8px 0;
          padding: 0 24px;
          width: 100%;
          /*max-width: 600px;*/
        }

        .toolbar {
          border-radius: 4px 4px 0px 0px;
        }
        .bottom {
          border-radius: 0px 0px 4px 4px;
        }
        .outer {
          height: 450px;
        }
      }
    </style>

    <app-route
        route="[[route]]"
        pattern="/:region/:category/:cag/:scenario/:runid"
        data="{{routeData}}"></app-route>

      <!-- Variable Graph -->
      <div class="content">
        <div class="left" id="graphdiv">
          <mint-ajax result="{{cagList}}" auto
            url="[[_createCagListURL(routeData)]]"></mint-ajax>
          <mint-ajax result="{{graphData}}" auto
            url="[[_createGraphURL(cagList, routeData)]]"></mint-ajax>
          <!-- TODO: Get Run Details >
          <mint-ajax result="{{runDetails}}" auto
            url="[[_getRunDetailsURL(routeData.runid)]]"></mint-ajax>
          -->
          <variable-graph id="cag" visible="[[visible]]"
            data="[[graphData]]" scenario="[[scenario]]" no-toolbar
            auto-load></variable-graph>
        </div>
        <div class="right" id="mapdiv">
          <!-- Top toolbar -->
          <div class="toolbar">
            <paper-button>MAP</paper-button>
          </div>
          <div class="outer">
            <template is="dom-if" if="[[visible]]">
              <mint-map id="mintmap"></mint-map>
            </template>
          </div>
          <div class="toolbar">
            <paper-button>&nbsp;</paper-button>
          </div>
        </div>
    </div>

  </template>

  <script>

    class MintResultsDetail extends Polymer.Element {
      static get is() { return 'mint-results-detail'; }

      static get properties() {
        return {
          server: String,
          userid: String,
          domain: String,
          graphData: {
            type: Object,
            observer: '_loadedGraph'
          },
          variables: {
            type: Array,
            notify: true,
            value: ['landuse']
          },
          visible: {
            type: Boolean,
            value: false,
            observer: '_visibleChanged'
          },
          scenario: Object,
          runid: String,
          route: Object,
          routeData: Object
        }
      }

      _loadedGraph(data) {
        /*console.log("Graph data loaded");
        console.log(data);*/
        // TODO: Setup Click listeners
        // On click
        // - Get Data associated with variable from runDetails
        // - Make query to Data Catalog to get dataset id + md5hash
        // - If available, then ask Map to visualise the variable
      }

      _createCagListURL(route) {
        if(route.region) {
          return "files/" + route.region + "/list.json";
        }
        return null;
      }

      _createGraphURL(caglist, route) {
        if(caglist && route.category && route.cag) {
          for(var i=0; i<caglist.length; i++) {
            var category = caglist[i];
            if(category.name == route.category) {
              for(var j=0; j<category.cags.length; j++) {
                var cag = category.cags[j];
                if(cag.id == route.cag) {
                  for(var k=0; k<cag.scenarios.length; k++) {
                    var scenario = cag.scenarios[k];
                    if(scenario.id == route.scenario) {
                      this.scenario = scenario;
                    }
                  }
                  return cag.json;
                }
              }
            }
          }
        }
        return null;
      }

      _visibleChanged(visible) {
        if(visible) {
          console.log("Set height and width of map");
          /*this.$.map.style.height = "700px";
          this.$.map.style.width = "100%";*/
        }
      }
    }

    customElements.define(MintResultsDetail.is, MintResultsDetail);

  </script>

</dom-module>
