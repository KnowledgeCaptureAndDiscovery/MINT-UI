<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="google-map-data-layer.html">
<link rel="import" href="mint-common-styles.html">
<link rel="import" href="mint-image.html">
<link rel="import" href="mint-cag-data.html">

<dom-module id="mint-cags-list">

  <template>

    <style include="mint-common-styles">

      .hero-image {
        position: relative;
        height: 280px;
        overflow: hidden;
        /*margin-bottom: 32px;*/
      }

      .hero-image {
        --mint-image-img: {
          position: absolute;
          top: 0;
          bottom: 0;
          left: -9999px;
          right: -9999px;
          max-width: none;
        };
      }

      .grid {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        @apply(--layout-justified);
        margin: 0 10px 32px 10px;
      }

      .grid > a {
        text-decoration: none;
      }
      #map {
        width:200px;
        height:150px;
      }
      .map {
        width: 200px;
        height: 150px;
        border: 2px solid var(--app-primary-color);
        border-radius: 4px;
        margin: 5px 0px;
      }
      .description {
        margin: 0px;
        margin-left: 15px;
        vertical-align: top;
      }
      .content {
        @apply(--layout-horizontal);
      }
      .box {
        @apply(--layout-vertical);
        background-color: #FEFEFE;
        border: 1px solid var(--app-primary-color);
        border-radius: 4px;
        width: 100%;
        background-size: 200px auto;
        background-position: 0px 24px;
        margin: 5px;
      }
      .inner {
        background: rgba(255,255,255,0.2);
        height: 100%;
        padding: 10px;
        font-weight: bold;
      }
      .textinner {
        background: rgba(255,255,255,0.9);
        height: 100%;
        border-radius: 4px;
      }
      .box.climate_projection {
        background-image: url("../images/categories/climate_projection.jpg");
      }
      .box.food_security_projection {
        background-image: url("../images/categories/food_security_projection.jpg");
      }
      .box.social_projection {
        background-image: url("../images/categories/social_projection.jpg");
      }
      .box h2 {
        font-size: 1.25em;
        text-align: center;
        margin: 0px;
        background-color: var(--app-accent-color);
        color: white;
      }
      .box h3 {
        font-size: 1.1em;
        border-bottom: 1px solid var(--app-accent-color);
        color: var(--app-accent-color);
        margin: 0px;
        padding-left: 5px;
      }
      .box ul {
        margin: 2px;
        padding-left: 20px;
      }
      .box ul li {
        padding: 3px 0px;
      }
      .box img {
        width: 200px;
        height: 100px;
      }
      @media (max-width: 767px) {
        .hero-image {
          display: none;
        }
        .description {
          margin: 0px;
          vertical-align: top;
        }
        .map {
          width: 100%;
        }
        .grid > .box {
          -webkit-flex-basis: 100%;
          flex-basis: 100%;
          max-width: 100%;
        }
        .content {
          @apply(--layout-vertical);
          @apply(--layout-center);
        }
      }

    </style>

    <!--
      app-route provides the name of the region.
    -->
    <app-route route="[[route]]" pattern="/:region" data="{{routeData}}"></app-route>

    <!--
      mint-cag-data provides the cags for a given region.
    -->
    <mint-cag-data id="cagData" regions="[[regions]]"
      region-name="[[routeData.region]]"
      region="{{region}}"
      cag="{{cag}}"></mint-cag-data>

    <header>
      <h2>[[region.title]]</h2>
      <!--span>[[_getPluralizedQuantity(region.cags.length)]]</span-->
    </header>

    <div class="content">
      <!-- Map -->
      <div class="map">
        <template is="dom-if" if="[[visible]]">
          <google-map id="map" api-key="AIzaSyAuaqVMFvr8yEr9WzFEDg0veeOQ2HDwoHU"
              disable-default-ui="" latitude="[[region.latitude]]"
              longitude="[[region.longitude]]"
              zoom="[[region.zoom]]"
              styles="[[mapStyles]]">
            <google-map-data-layer url="[[_createGeoJsonURL(region, visible)]]"></google-map-data-layer>
          </google-map>
        </template>
      </div>
      <!-- Description-->
      <div class="description">
        [[region.description]]
      </div>
    </div>

    <div class="content">
      <template is="dom-repeat" items="[[_getListItems(region.categories)]]" as="cat">
        <div class$="box [[cat.name]]">
          <h2>[[cat.title]]</h2>
          <div class="inner">
            <div class="textinner">
              <template is="dom-repeat" items="[[cat.cags]]" as="cag">
                <h3>[[cag.name]]</h3>
                <ul>
                  <template is="dom-repeat" items="[[cag.scenarios]]" as="scenario">
                    <li>
                      <a href="cags/detail/[[region.name]]/[[cat.name]]/[[cag.id]]/[[scenario.id]]">
                      [[scenario.name]]</a>
                    </li>
                  </template>
                </ul>
              </template>
            </div>
          </div>
        </div>
      </template>
    </div>

    <!--
    <div class="grid" hidden$="[[failure]]">
      <template is="dom-repeat" items="[[_getListItems(region.cags)]]" initial-count="4">
        <a href$="[[_getItemHref(cag)]]">
          <mint-list-cag cag="[[cag]]"></mint-list-cag>
        </a>
      </template>
    </div>
    -->

  </template>

  <script>

    class MintCagsList extends Polymer.Element {
      static get is() { return 'mint-cags-list'; }

      static get properties() {
        return {
          regions: Array,
          region: {
            type: Object,
            notify: true
          },
          route: Object,
          routeData: Object,
          visible: Boolean,
          geoJsonURL: String,
          mapStyles: {
            type: String,
            value:[{"featureType":"landscape","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"poi","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"stylers":[{"hue":"#00aaff"},{"saturation":-100},{"gamma":2.15},{"lightness":12}]},{"featureType":"road","elementType":"labels.text.fill","stylers":[{"visibility":"on"},{"lightness":24}]},{"featureType":"road","elementType":"geometry","stylers":[{"lightness":57}]}]
          }
        };
      }

      static get observers() {
        return [
          '_regionChanged(region, visible)'
        ];
      }

      _getListItems(cags) {
        // Return placeholder cags when the cags haven't loaded yet.
        return cags || [];
      }

      _getItemHref(cag) {
        // By returning null when `cagId` is undefined, the href attribute won't be set and
        // the link will be disabled.
        return cag.name ? ['cags/detail', this.region.name, cag.name].join('/') : null;
      }

      _getPluralizedQuantity(quantity) {
        if (!quantity) {
          return '';
        }
        var pluralizedQ = quantity === 1 ? 'y' : 'ies';
        return  '(' + quantity + ' categor' + pluralizedQ + ')';
      }

      _regionChanged(region, visible) {
        if (!visible)
          return;
        if (!this.route || !this.route.prefix.endsWith("/cags/list"))
          return;

        var me = this;
        this._changeSectionDebouncer = Polymer.Debouncer.debounce(this._changeSectionDebouncer,
          Polymer.Async.microTask, () => {
            if (region) {
              // Notify the region and the page's title
              this.dispatchEvent(new CustomEvent('change-section', {
                bubbles: true, composed: true, detail: {
                  region: region.name,
                  title: region.title
                }}));
            } else {
              this.dispatchEvent(new CustomEvent('show-invalid-url-warning', {
                bubbles: true, composed: true}));
            }
          });
      }

      _createGeoJsonURL(region, visible) {
        if(region && visible) {
          var url = "files/regions/" + region.name + "/geojson.json";
          //console.log(url);
          return url;
        }
        return null;
      }
    }

    customElements.define(MintCagsList.is, MintCagsList);
  </script>

</dom-module>
