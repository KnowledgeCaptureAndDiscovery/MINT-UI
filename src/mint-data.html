<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/file-upload/file-upload.html">
<link rel="import" href="mint-ajax.html">

<dom-module id="mint-data">

  <template>

    <style include="mint-common-styles">

      .item {
        display: block;
        text-decoration: none;
        text-align: center;
        margin-bottom: 40px;
      }

      h2 {
        font-size: 1.3em;
        font-weight: 500;
        margin: 32px 0;
      }

      .detail {
        margin: 10px;
        margin-top: 0px;
        width: calc(100% - 20px);
        transition: opacity 0.4s;
        @apply(--layout-center-justified);
      }

      .grid {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        @apply(--layout-center);
        display: flex;
        flex-flow: row wrap;
        border: 1px solid #E3E3E3;
        border-width: 1px 0px 0px 1px;
      }

      .grid > a {
        -webkit-flex: 1 1;
        flex: 1 1;
        -webkit-flex-basis: calc(33.3333% - 11px);
        flex-basis: calc(33.3333% - 11px);
        max-width: calc(33.3333% - 11px);
        padding-left: 10px;
        height: 34px;
        line-height:34px;
        /*color: black;*/
        text-decoration: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border: 1px solid #E3E3E3;
        border-width: 0px 1px 1px 0px;
      }

      .grid > a:hover {
        background-color: #EEEEEE;
        text-decoration: underline;
      }

      .section {
        /*border: 1px solid #E3E3E3;*/
        margin-bottom: 15px;
      }

      .section .content {

      }

      .section .head {
        color: var(--app-secondary-color);
        font-size: 12px;
        height: 42px;
        line-height:42px;
        font-weight: 500;
        padding: 0px 10px;
        border: 1px solid #E3E3E3;
        border-width: 1px 1px 0px 1px;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06), 0 2px 0 rgba(0, 0, 0, 0.075), 0 3px 0 rgba(0, 0, 0, 0.05), 0 4px 0 rgba(0, 0, 0, 0.015);
      }

      .section .upload {
        padding-top: 10px;
        border: 1px solid #E3E3E3;
        border-width: 0px 1px 0px 1px;
      }


      file-upload {
        padding:5px;

        --file-upload-upload-border: {
          padding: 0px;
          border-color: #D3D3D3;
          color: rgba(0, 0, 0, 0.54);
          margin-bottom:8px;
        };
        --file-upload-upload-border-hover: {
          background-color: #EEEEEE;
        };
        --file-upload-drop-area: {
          padding: 8px;
          width: 200px;
        };
        --file-upload-button: {
          margin-bottom: 0px;
          /*background-color: var(--app-primary-color);
          color: white;*/
        };
        --file-upload-file: {
          padding: 4px;
          width: 200px;
        }
      }

      file-upload iron-icon {
        height: 16px;
      }

      @media (max-width: 767px) {
        h2 {
          margin: 24px 0;
        }

        .grid a {
          -webkit-flex-basis: calc(50% - 11px);
          flex-basis: calc(50% - 11px);
          max-width: calc(50% - 11px);
        }

      }

    </style>

    <mint-ajax id="datalistAjax" result="{{dataItems}}" auto
      url="[[_getRequestUrl(server, userid, domain)]]"></mint-ajax>

    <mint-ajax id="newdataAjax" raw on-mint-ajax-load="_setDataLocation"></mint-ajax>
    <mint-ajax id="registerDataAjax" raw on-mint-ajax-load="_updateDataItems"></mint-ajax>

    <div class="detail" has-content$="[[_isDefined(dataItems)]]">
      <template is="dom-repeat" items="[[_hashKeys(dataItems)]]" as="typeid">
        <div class="section">
          <div class="head">[[_localName(typeid)]]</div>
          <div class="upload">
            <file-upload target="[[_getUploadUrl(server, userid, domain)]]" additional=[[uploadData]]
              method="POST" with-credentials multi droppable data-type$="[[typeid]]"
              on-success="_registerData">
                <iron-icon icon="file-upload"></iron-icon>Upload
            </file-upload>
          </div>
          <div class="grid">
            <template is="dom-repeat" items="[[_dataForType(dataItems, typeid)]]" as="dataid">
              <a href="[[server]]/users/[[userid]]/[[domain]]/data/fetch?data_id=[[_escape(dataid)]]">
                [[_localName(dataid)]]</a>
            </template>
          </div>
        </div>
      </template>
    </div>
    <div class="detail" has-content$="[[!loggedIn]]">
      You need to be logged in to see this section
    </div>

  </template>

  <script>

    Polymer({

      is: 'mint-data',

      properties: {
        server: String,
        userid: {
          type: String,
          observer: '_checkLogin'
        },
        domain: String,
        dataItems: Object,
        uploadData: {
          type: Object,
          value: {'type': 'data'}
        },
        loggedIn: {
          type: Boolean,
          value: false,
          computed: '_computeLoggedInStatus(userid)'
        }
      },

      _computeLoggedInStatus: function(userid) {
        return userid != null;
      },

      _isDefined: function(item) {
        return item != null;
      },

      _hashKeys: function(hash) {
        if(hash)
          return Object.keys(hash).sort();
      },

      _checkLogin: function(userid) {
        if(!userid)
          this.dataItems = null;
      },

      _registerData: function(e) {
        var detail = e.detail;
        var response = JSON.parse(detail.xhr.response);
        if(response.success) {
          var datatype = e.target.getAttribute('data-type');
          var dataloc = response.location;
          var dataname = dataloc.replace(/.+\//, '');
          var newdataname = this._getRDFId(dataname);
          var dataid = this.server + "/export/users/" + this.userid +  "/" + this.domain + "/data/library.owl#" + newdataname;
          var url = this.server + "/users/" + this.userid +  "/" + this.domain + "/data/addDataForType";
          var postdata = "data_id=" + escape(dataid) + "&data_type=" + escape(datatype);
          this.$.newdataAjax.url = url;
          this.$.newdataAjax.data = postdata;
          this.$.newdataAjax.fetch({location:dataloc, name:dataname, datatype:datatype, dataid:dataid});
        }
      },

      _setDataLocation: function(e) {
        var info = e.detail.info;
        var url = this.server + "/users/" + this.userid +  "/" + this.domain + "/data/setDataLocation";
        var postdata = "data_id=" + escape(info.dataid) + "&location=" + escape(info.location);
        this.$.registerDataAjax.url = url;
        this.$.registerDataAjax.data = postdata;
        this.$.registerDataAjax.fetch({dataid: info.dataid, datatype:info.datatype});
      },

      _updateDataItems: function(e) {
        var info = e.detail.info;
        // To trigger a change
        var items = JSON.parse(JSON.stringify(this.dataItems));
        items[info.datatype].push(info.dataid);
        this.dataItems = items;
      },

      _getRDFId: function(id) {
        id = id.replace(/[^a-zA-Z0-9_\-\.]/g, '_');
        if (id.match(/^([0-9]|\.|\-)/))
          id = '_' + id;
        return id;
      },

      _dataForType: function(hash, key) {
        if(hash)
          return hash[key];
      },

      _escape: function(url) {
        return escape(url);
      },

      _localName: function(url) {
        return url.replace(/^.*#/, '');
      },

      _getRequestUrl: function(server, userid, domain) {
        return server + "/users/" + userid +  "/" + domain + "/data/getDataListJSON";
      },

      _getUploadUrl: function(server, userid, domain) {
        return server + "/users/" + userid +  "/" + domain + "/upload";
      }
    });

  </script>

</dom-module>
