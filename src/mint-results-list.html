<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-column.html">

<link rel="import" href="mint-ajax.html">

<dom-module id="mint-results-list">

  <template>

    <style>

      .detail {
        margin: 10px;
        margin-top: 0px;
        transition: opacity 0.4s;
        opacity: 0;
      }

      .detail[has-content] {
        opacity: 1;
      }

      .item {
        display: block;
        text-decoration: none;
        text-align: center;
        margin-bottom: 40px;
      }

      h2 {
        font-size: 1.3em;
        font-weight: 500;
        margin: 32px 0;
      }
      table {
          border-collapse: collapse;
          border: 2px solid rgb(200, 200, 200);
          letter-spacing: 1px;
          font-family: sans-serif;
          font-size: .8rem;
      }
      vaadin-grid {
        font-family: "Roboto", "Noto", sans-serif;
        font-size: 13px;
      }
      @media (max-width: 767px) {
        h2 {
          margin: 24px 0;
        }
        .detail {
          margin: 0px 16px;
        }
      }

    </style>

    <template is="dom-if" if="[[!userid]]">
      <div class="detail" has-content="">
        You need to be logged in to see this section
      </div>
    </template>

    <iron-ajax auto url="[[_getRunListURL()]]" handle-as="json" last-response="{{runs}}"></iron-ajax>

    <vaadin-grid items="[[runs]]">
      <vaadin-grid-column width="5em">
        <template class="header">
          <vaadin-grid-sorter path="region.id">Region</vaadin-grid-sorter>
        </template>
        <template>[[item.region.name]]</template>
      </vaadin-grid-column>

      <vaadin-grid-column width="5em">
        <template class="header">
          <vaadin-grid-sorter path="category.id">Category</vaadin-grid-sorter>
        </template>
        <template>[[item.category.name]]</template>
      </vaadin-grid-column>

      <vaadin-grid-column width="5em">
        <template class="header">
          <vaadin-grid-sorter path="cag.id">CAG</vaadin-grid-sorter>
        </template>
        <template>[[item.cag.name]]</template>
      </vaadin-grid-column>

      <vaadin-grid-column width="5em">
        <template class="header">
          <vaadin-grid-sorter path="scenario.id">Scenario</vaadin-grid-sorter>
        </template>
        <template>[[item.scenario.name]]</template>
      </vaadin-grid-column>

      <vaadin-grid-column width="15em" flex-grow="2">
        <template class="header">
          <vaadin-grid-sorter path="run.name">Run</vaadin-grid-sorter>
        </template>
        <template>
          <a href="results/detail/[[item.region.id]]/[[item.category.id]]/[[item.cag.id]]/[[item.run.id]]"
            >[[item.run.name]]</a>
        </template>
      </vaadin-grid-column>

    </vaadin-grid>

  </template>

  <script>

  class MintResultsList extends Polymer.Element {
    static get is() { return 'mint-results-list'; }

    static get properties() {
      return {
        server: String,
        userid: String,
        domain: String,
        runs: Array,
        visible: {
          type: Boolean,
          value: false
        },
        selectedrunid: {
          type: String,
          value: null,
          notify: true
        },
        loggedIn: {
          type: Boolean,
          value: false,
          computed: '_computeLoggedInStatus(userid)'
        },
        runList: Array
      };
    }

    static get observers() {
      return [
        //'_fetchResults(server, userid, domain, visible)',
        //'_checkVisibility(visible)'
      ];
    }

    _computeLoggedInStatus(userid) {
      return userid != null;
    }

    ready() {
      super.ready();
      /*
      this._setupListeners();
      Polymer.RenderStatus.afterNextRender(this, function() {
        this._setupRenderers();
      });
      */
    }

    _getRunListURL() {
      return "files/runs/list.json";
    }

    _sortList(list) {
      if(list != null) {
        list.sort(function(a, b) {
          return a.runtimeInfo.startTime < b.runtimeInfo.startTime ? 1 : -1;
        });
        return list;
      }
    }

    _checkVisibility(visible) {
      if(visible) {
        this.selectedrunid = null;
        this.$.results.selection.clear();
      }
    }

    _fetchResults(server, userid, domain, visible) {
      if(server && userid && domain && visible) {
      }
      else {
        this.runList = [];
      }
    }

    _getRequestUrl(server, userid, domain) {
      return server + "/users/" + userid +  "/" + domain + "/";
    }

    _progressRenderer(cell) {
      var d = cell.row.data;
      var r = d.runtimeInfo;
      if (r.status == "SUCCESS")
        d.percent_done = 100;
      var w1 = 150;
      var w2 = Math.round(w1 * (d.percent_done + d.percent_failed + d.percent_running) / 100);
      var w3 = Math.round(w1 * (d.percent_done + d.percent_running) / 100);
      var w4 = Math.round(w1 * d.percent_done / 100);
      var html = "<div style='width:"+w1+"px;height:8px;background-color:#EEE;border-radius:5px'>";
    	html += "<div style='width:"+w2+"px;height:8px;background-color:#F66;border-radius:5px'>";
    	html += "<div style='width:"+w3+"px;height:8x;background-color:#999;border-radius:5px'>";
    	html += "<div style='width:"+w4+"px;height:8px;background-color:#6E6;border-radius:5px'>";
    	html += "&nbsp;</div></div></div></div>";
      cell.element.innerHTML = html;
    }

    _timeRenderer(cell) {
      if(cell.data)
        cell.element.innerHTML = new Date(cell.data*1000).toISOString().slice(0,19).replace('T', ' ');
    }

    _titleRenderer(cell) {
      cell.element.innerHTML = '<b>' + cell.data.replace(/^.*#/, '') + '</b>';
    }

    _statusRenderer(cell) {
      cell.element.innerHTML = '';
      var child = document.createElement('iron-icon');
      if(cell.data == 'SUCCESS') {
        child.setAttribute('icon', 'check');
        child.setAttribute('style', 'color:green');
      } else if(cell.data == 'FAILURE') {
        child.setAttribute('icon', 'close');
        child.setAttribute('style', 'color:red');
      } else {
        child.setAttribute('icon', 'hourglass-empty');
        child.setAttribute('style', 'color:grey');
      }
      cell.element.appendChild(child);
    }

    _setupRenderers() {
      var grid = this.$.results;
      grid.columns[1].renderer = this._statusRenderer;
      grid.columns[2].renderer = this._titleRenderer;
      grid.columns[3].renderer = this._timeRenderer;
      grid.columns[4].renderer = this._timeRenderer;
      grid.columns[5].renderer = this._progressRenderer;
    }

    _setupReloadTimer() {
      var me = this;
      window.setTimeout(function() {
        if(me.userid && me.visible) {
          //console.log("Refreshing");
          me.$.runlistAjax.refresh();
          me._setupReloadTimer();
        }
      }, 30000);
    }

    _isDefined(item) {
      return item != null;
    }

    _setupListeners() {
    }
  }

  customElements.define(MintResultsList.is, MintResultsList);

  </script>

</dom-module>
