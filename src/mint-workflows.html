<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="mint-icons.html">
<link rel="import" href="d3-import.html">
<link rel="import" href="wings-workflow.html">
<link rel="import" href="mint-common-styles.html">

<dom-module id="mint-workflows">
  <template>
    <style include="mint-common-styles">
      :host {
        display: block;
      }
      .toolbar {
        border-radius: 0px 4px 0px 0px;
      }
      .bottom {
        border-radius: 0px 0px 4px 0px;
      }
      .toolbar paper-button {
        min-width:32px;
      }
      .horiz {
        @apply --layout-horizontal;
      }
      .horiz div {
        padding-right:5px;
      }
      #canvas {
        width:100%;
        height:100%;
      }
      paper-input, paper-dropdown-menu-light {
        margin:0px;
        width: calc(100% - 50px);
        --paper-input-container: {
          padding: 2px 0px;
        }
      }
      paper-dialog {
        width:400px;
        max-width: 80%;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        background-color: white;
        border: 2px solid var(--app-accent-color);
        border-radius: 4px;
      }
      .heading {
        margin:0px;
        padding-top:4px;
        font-size:18px;
        margin-bottom:8px;
        background-color: var(--app-accent-color);
        color:white;
      }
      paper-toggle-button {
        --paper-toggle-button-checked-button-color:  white;
        --paper-toggle-button-unchecked-button-color:  var(--app-accent-color);
        --paper-toggle-button-label-color:  white;
      }
      paper-item {
        min-height: 32px;
        padding-left:6px;
        font-size: 13px;
      }
      .toolbar paper-button, .toolbar paper-icon-button {
        max-height: 36px;
        color: white;
      }
      paper-button.delete {
        float:left;
        color: var(--paper-red-500);
      }
      paper-button.delete:hover {
        background-color: var(--paper-red-400);
        color:white;
      }
      paper-listbox {
        display: inline;
        cursor: pointer;
      }
      div.grow {
        flex-grow:2;
      }

      @media (max-width: 767px) {
        .toolbar {
          border-radius: 4px 4px 0px 0px;
        }
        .bottom {
          border-radius: 0px 0px 4px 4px;
        }
        .outer {
          height: 450px;
        }
      }

    </style>

    <!-- Top toolbar -->
    <div class="toolbar">
      <template is="dom-if" if="[[_workflowDefined(selectedWorkflow)]]">
        <paper-icon-button icon="arrow-back" on-click="_backToList"></paper-icon-button>
      </template>
      <div class="grow">&nbsp;</div>
      <template is="dom-if" if="[[!_workflowDefined(selectedWorkflow)]]">
        <paper-button>Model Graphs</paper-button>
      </template>
      <template is="dom-if" if="[[_showingWorkflows(selectedWorkflow, showWorkflows)]]">
        <paper-button raised on-click="runWorkflow">Run Workflow</paper-button>
      </template>
      <div class="grow">&nbsp;</div>
      <paper-icon-button icon="close" on-click="_resetWorkflows"></paper-icon-button>
    </div>

    <!-- Variable Graph Canvas -->
    <div class="outer">
      <iron-collapse id="list_section" opened no-animation>
        <paper-listbox id="workflow_listbox" on-selected-changed="_changedSelection">
          <template is="dom-repeat" items="[[workflows]]" as="workflow" index-as="windex">
            <paper-item>
              <div class="horiz">
                <div>[[_plusone(windex)]].</div>
                <div>
                  <template is="dom-repeat" items="[[_getWorkflowNodes(workflow)]]"
                    as="node"><template is="dom-if"
                      if="[[index]]">&nbsp;/&nbsp;
                  </template>[[node.name]]</template>
                </div>
              </div>
            </paper-item>
          </template>
        </paper-listbox>
      </iron-collapse>
      <iron-collapse id="workflow_section" no-animation>
        <wings-workflow id="workflow" data="[[_getWorkflowView(selectedWorkflow)]]" selected="{{selectedItems}}"></wings-workflow>
      </iron-collapse>
    </div>

    <!-- Bottom toolbar -->
    <div class="toolbar bottom">
      <paper-button>&nbsp;</paper-button>
      <template is="dom-if" if="[[_workflowDefined(selectedWorkflow)]]">
        <paper-button on-click="zoomIn">+</paper-button>
        <paper-button on-click="zoomOut">-</paper-button>
      </template>
      <paper-toggle-button id="toggler" checked="{{showWorkflows}}"
        on-checked-changed="toggleView">WORKFLOW</paper-toggle-button>
    </div>

    <!-- Workflow Run Status dialog -->
    <paper-dialog id="runwindow">
      <div class="heading">Workflow Run</div>
      <div id="runstatus"></div>
    </paper-dialog>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class MintWorkflows extends Polymer.Element {
      static get is() {
        return 'mint-workflows';
      }
      static get properties() {
        return {
          server: String,
          userid: String,
          domain: String,
          workflows: {
            type: Array,
            notify: true
          },
          selectedWorkflow: {
            type: Object,
            notify: true
          },
          selectedGraph: {
            type: Object,
            notify: true
          },
          selectedItems: {
            type: Array,
            notify: true
          },
          showWorkflows: Boolean
        }
      }

      _resetWorkflows() {
        this.$.workflow_listbox.items = [];
        this.$.workflow_listbox.selected = null;
        this.$.list_section.show();
        this.$.workflow_section.hide();
        this.set("workflows", []);
        this.set("selectedWorkflow", null);
        this.set("selectedGraph", null);
      }

      _plusone(index) {
        return index+1;
      }

      _changedSelection(e, item) {
        if(item && item.value != null) {
          this.$.list_section.toggle();
          this.$.workflow_section.toggle();
          this.set("selectedWorkflow", this.workflows[item.value]);
          this.set("selectedGraph", this.selectedWorkflow.graph);
        }
      }

      _backToList(e) {
        this.$.list_section.toggle();
        this.$.workflow_section.toggle();
        this.$.workflow_listbox.selected = null;
        this.set("selectedWorkflow", null);
        this.set("selectedGraph", null);
      }

      _getWorkflowNodes(workflow) {
        if(workflow)
          return Object.values(workflow.model_graph.template.Nodes);
      }

      _workflowDefined(w) {
        return (w != null && w != undefined);
      }

      _showingWorkflows(w) {
        return this._workflowDefined(w) && this.showWorkflows;
      }

      _getWorkflowView(w) {
        if(!w)
          return;
        if(this.$.toggler.checked)
          return w.wings_workflow;
        else
          return w.model_graph;
      }

      zoomIn() {
        this.$.workflow.zoomIn();
      }

      zoomOut() {
        this.$.workflow.zoomOut();
      }

      runWorkflow() {
        var tpl = this.selectedWorkflow.wings_workflow.template;
        var gtpl = this.$.workflow.template;

        // Add coordinates to Nodes and Variables
        for(var nid in tpl.Nodes) {
          var coords = gtpl.nodes[nid].getCoords();
          tpl.Nodes[nid].comment = "center:x="+coords.x+",y="+coords.y;
        }
        for(var vid in tpl.Variables) {
          var coords = gtpl.variables[vid].getCoords();
          tpl.Variables[vid].comment = "center:x="+coords.x+",y="+coords.y;
        }

        this.$.runwindow.open();

        var me = this;
        // Save all components from workflow that aren't present
        me._addUnknownComponents(tpl, function() {
          // Save Template
          me._saveTemplate(tpl, function() {
            me._openTemplateInWings(tpl);
          });
        });
      }

      toggleView(d) {
        if(!this.selectedWorkflow)
          return;
        if(this.$.toggler.checked)
          this.$.workflow.set("data", this.selectedWorkflow.wings_workflow);
        else
          this.$.workflow.set("data", this.selectedWorkflow.model_graph);
      }

      _addUnknownComponents(tpl, fn) {
        var tpl_comps = {};
        // FIXME: Using the top dataobject as the role type here
        var topdata = tpl.props["ont.data.url"] + "#DataObject";
        var xsdns = "http://www.w3.org/2001/XMLSchema#";

        // Convert Template Nodes to Wings components
        for(var nid in tpl.Nodes) {
          var node = tpl.Nodes[nid];
          var cid = node.componentVariable.binding.id;
          var c = {
            id: cid,
            type: 1,
            inputs: [],
            outputs: [],
            rules: [],
            inheritedRules: [],
            requirement: {
              storageGB: 0,
              memoryGB: 0,
              needs64bit: false,
              softwareIds: []
            }
          };
          var i=1;
          var p=1;
          for(var pid in node.inputPorts) {
            var port = node.inputPorts[pid];
            var role = {
              id: cid + "_" + port.role.roleid,
              dimensionality: port.role.dimensionality,
              role: port.role.roleid
            };
            if(port.role.type == 2) {
              // Parameter
              role.prefix = "-p" + p++;
              role.isParam = true;
              //FIXME: Using xsd string as roleytpe here
              role.type = xsdns + "string";
            }
            else {
              // Data
              role.prefix = "-i" + i++;
              role.isParam = false;
              // FIXME: Using topdata as roletype here
              role.type = topdata;
            }
            c.inputs.push(role);
          }
          var o=1;
          for(var pid in node.outputPorts) {
            var port = node.outputPorts[pid];
            c.outputs.push({
              id: cid + "_" + port.role.roleid,
              dimensionality: port.role.dimensionality,
              role: port.role.roleid,
              prefix: "-o" + o++,
              isParam: false,
              // FIXME: Using topdata as roletype here
              type: topdata
            });
          }
          tpl_comps[cid] = c;
        }

        // Save components that aren't in Wings
        var me = this;
        this._getComponents(function(cmap, ctop) {
          for (var cid in cmap) {
            if(cid in tpl_comps)
              delete tpl_comps[cid];
          }
          // If all already accounted for, call callback
          var numleft = Object.keys(tpl_comps).length;
          if(numleft == 0)
            fn();

          for(cid in tpl_comps) {
            var c = tpl_comps[cid];

            // Add component and save component description (I/O etc)
            me._addComponent(c, ctop, function(comp) {
              me._saveComponentJSON(comp, function(comp2) {
                delete tpl_comps[comp2.id];
                var numleft = Object.keys(tpl_comps).length;
                // If all saved, then call callback
                if(numleft == 0)
                  fn();
              });
            });
          }
        })
      }

      _getComponents(fn) {
        // Get url prefix for operations
        var purl = this.server + "/users/" + this.userid + "/" + this.domain;
        this._getResource({
          url: purl + "/components/getComponentHierarchyJSON",
          onLoad: function(e) {
            var ctree = JSON.parse(e.target.responseText);
            var ctop = ctree.cls.id;
            var cmap = this._getComponentMap(ctree, {});
            fn(cmap, ctop);
          },
          onError: function() {
            console.log("Cannot fetch components");
          }
        })
      }

      _getComponentMap(node, map) {
        var comp = node.cls.component;
        if(comp) {
          map[comp.id] = comp;
        }
        for(var i=0; i<node.children.length; i++) {
          map = this._getComponentMap(node.children[i], map);
        }
        return map;
      }

      _addComponent(c, ctop, fn) {
        // Get url prefix for operations
        var purl = this.server + "/users/" + this.userid + "/" + this.domain;
        var data = "cid=" + encodeURIComponent(c.id);
        data += "&parent_cid=";
        data += "&parent_type=" + encodeURIComponent(ctop);
        Polymer.dom(this.$.runstatus).innerHTML = "Adding component "+c.id;

        // fn();
        this._postResource({
          url: purl + "/components/type/addComponent",
          onLoad: function(e) {
            if(e.target.responseText == "OK")
              fn(c);
          },
          onError: function() {
            console.log("Cannot save");
          }
        }, data);
      }

      _saveComponentJSON(c, fn) {
        // Get url prefix for operations
        var purl = this.server + "/users/" + this.userid + "/" + this.domain;
        var data = "cid=" + encodeURIComponent(c.id);
        data += "&component_json=" + encodeURIComponent(JSON.stringify(c));
        // fn();
        this._postResource({
          url: purl + "/components/type/saveComponentJSON",
          onLoad: function(e) {
            if(e.target.responseText == "OK")
              fn(c);
          },
          onError: function() {
            console.log("Cannot save");
          }
        }, data);
      }

      _saveTemplate(tpl, fn) {
        //TODO: Get a MD5 Hash for template to check if it is already saved.
        // - To avoid cluttering up template library

        // Get url prefix for operations
        var purl = this.server + "/users/" + this.userid + "/" + this.domain;
        var data = "template_id=" + encodeURIComponent(tpl.id);
        data += "&constraints_json=[]";
        data += "&json=" + encodeURIComponent(JSON.stringify(tpl));
        Polymer.dom(this.$.runstatus).innerHTML = "Saving Template in Wings";
        // fn();
        this._postResource({
          url: purl + "/workflows/saveTemplateJSON",
          onLoad: function(e) {
            fn();
          },
          onError: function() {
            console.log("Cannot save");
          }
        }, data);
      }

      _openTemplateInWings(tpl) {
        var url = tpl.id.replace("/export", "");
        Polymer.dom(this.$.runstatus).innerHTML = "Workflow Saved<br />" +
          "<a target='_blank' href='" + url +
          "'>Run workflow in Wings</a>";
      }

      _getResource(rq) {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener('load', rq.onLoad.bind(this));
        xhr.addEventListener('error', rq.onError.bind(this));
        xhr.withCredentials = true;
        xhr.open('GET', rq.url);
        xhr.send();
      }

      _postResource(rq, data) {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener('load', rq.onLoad.bind(this));
        xhr.addEventListener('error', rq.onError.bind(this));
        xhr.withCredentials = true;
        xhr.open('POST', rq.url, true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.send(data);
      }

    }
    window.customElements.define(MintWorkflows.is, MintWorkflows);

  </script>
</dom-module>
