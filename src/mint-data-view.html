<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/mint-map/mint-map.html">
<link rel="import" href="../bower_components/mint-chart/mint-chart.html">
<link rel="import" href="../bower_components/mint-time/mint-time.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="mint-common-styles.html">

<dom-module id="mint-data-view">
  <template>
    <style include="mint-common-styles">
      mint-map, mint-chart, mint-time {
        height: 650px;
      }
      .visualisation {
        margin-bottom: 40px;
      }
    </style>

    <app-route
        route="[[route]]"
        pattern="/:standardName/:jsonHash"
        data="{{routeData}}"></app-route>

    <div class="visualisation">
      <div class="toolbar">
        <paper-button>MAP: [[datasetName]]</paper-button>
      </div>
      <div class="outer">
        <template is="dom-if" if="[[visible]]">
          <mint-map variables="[[variables]]"></mint-map>
        </template>
      </div>
      <div class="toolbar bottom">
        <paper-button>&nbsp;</paper-button>
      </div>
    </div>

    <div class="visualisation">
      <div class="toolbar">
        <paper-button>CHART: [[datasetName]]</paper-button>
      </div>
      <div class="outer">
        <template is="dom-if" if="[[visible]]">
          <mint-chart variables$="[[variables]]"></mint-chart>
        </template>
      </div>
      <div class="toolbar bottom">
        <paper-button>&nbsp;</paper-button>
      </div>
    </div>

    <div class="visualisation">
      <div class="toolbar">
        <paper-button>TIMELINE: [[datasetName]]</paper-button>
      </div>
      <div class="outer">
        <template is="dom-if" if="[[visible]]">
          <mint-time variables="[[variables]]"></mint-time>
        </template>
      </div>
      <div class="toolbar bottom">
        <paper-button>&nbsp;</paper-button>
      </div>
    </div>

  </template>

  <script>

    class MintDataView extends Polymer.Element {
      static get is() { return 'mint-data-view'; }

      static get properties() {
        return {
          route: Object,
          dataCatalog: Object,
          standardName: String,
          datasetName: String,
          variableId: String,
          fileLocation: String,
          md5Hash: String,
          dataList: Array,
          routeData: Object,
          variables: {
            type: Array,
            notify: true
          },
          visible: Boolean
        };
      }

      static get observers() {
        return [
          '_routeDataChanged(routeData.standardName, routeData.jsonHash)'
        ];
      }

      _routeDataChanged(standardName, jsonHash) {
        var me = this;
        if(standardName &&
            jsonHash && this.jsonHash != jsonHash) {
          var item = JSON.parse(atob(jsonHash.replace("|", "/")));
          // console.log(item);
          this.set("standardName", standardName);
          this.set("datasetName", item.ds);
          this.set("variableId", item.id);
          this.set("md5Hash", item.md5);
          var variable = {
            name: me.standardName,
            stdname: me.standardName,
            md5: me.md5Hash,
            uri: me.variableId
          };
          me.set("variables", [variable]);
        }
      }

      _getFileLocation(vid, fn) {
        this.dataCatalog.getDatasetLocation(vid, function(list) {
          if(list.length > 0)
            fn(list[0].storage_path.value);
        });
      }
    }

    customElements.define(MintDataView.is, MintDataView);
  </script>
</dom-module>
