<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="mint-data-catalog">
  <script>
    class MintDataCatalog extends Polymer.Element {
      static get is() {
        return 'mint-data-catalog';
      }

      static get properties() {
        return {
          server: String,
          dataCatalog: {
            type: Object,
            notify: true
          }
        };
      }

      constructor() {
        super();
        this.set("dataCatalog", this);
      }

      searchVariables(term, fn) {
        var response = {"data":[{"class":"http://www.geoscienceontology.org/geo-lower/variable#atmosphere_water__one-hour_time_integral_of_precipitation_leq-volume_flux","dataset_count":0,"label_name":"atmosphere_water__one-hour_time_integral_of_precipitation_leq-volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/variable#atmosphere_water__precipitation_leq-volume_flux","dataset_count":0,"label_name":"atmosphere_water__precipitation_leq-volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/variable#sea_surface_water__precipitation_mass_flux","dataset_count":0,"label_name":"sea_surface_water__precipitation_mass_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/variable#atmosphere_sleet__precipitation_duration","dataset_count":0,"label_name":"atmosphere_sleet__precipitation_duration","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/variable#atmosphere_water__domain_time_max_of_precipitation_leq-volume_flux","dataset_count":0,"label_name":"atmosphere_water__domain_time_max_of_precipitation_leq-volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/variable#sea_surface_water__precipitation_leq-volume_flux","dataset_count":0,"label_name":"sea_surface_water__precipitation_leq-volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/quantity#one-year_time_integral_of_precipitation_leq-volume_flux","dataset_count":0,"label_name":"one-year_time_integral_of_precipitation_leq-volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/variable#atmosphere_water__one-day_time_integral_of_precipitation_leq-volume_flux","dataset_count":0,"label_name":"atmosphere_water__one-day_time_integral_of_precipitation_leq-volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/variable#titan_atmosphere_methane__precipitation_leq-volume_flux","dataset_count":0,"label_name":"titan_atmosphere_methane__precipitation_leq-volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/quantity#one-hour_time_integral_of_precipitation_leq-volume_flux","dataset_count":0,"label_name":"one-hour_time_integral_of_precipitation_leq-volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/quantity#domain_time_max_of_precipitation_leq-volume_flux","dataset_count":0,"label_name":"domain_time_max_of_precipitation_leq-volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/quantity#precipitation_leq-volume_flux","dataset_count":0,"label_name":"precipitation_leq-volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/quantity#one-day_time_integral_of_precipitation_leq-volume_flux","dataset_count":0,"label_name":"one-day_time_integral_of_precipitation_leq-volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/variable#atmosphere_ice__precipitation_volume_flux","dataset_count":0,"label_name":"atmosphere_ice__precipitation_volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/variable#atmosphere_snow__precipitation_duration","dataset_count":0,"label_name":"atmosphere_snow__precipitation_duration","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/variable#atmosphere_hail__precipitation_volume_flux","dataset_count":0,"label_name":"atmosphere_hail__precipitation_volume_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/variable#atmosphere_water__precipitation_duration","dataset_count":0,"label_name":"atmosphere_water__precipitation_duration","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/quantity#precipitation_mass_flux","dataset_count":0,"label_name":"precipitation_mass_flux","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/variable#atmosphere_hail__precipitation_duration","dataset_count":0,"label_name":"atmosphere_hail__precipitation_duration","score":5.28},{"class":"http://www.geoscienceontology.org/geo-lower/process#precipitation","dataset_count":0,"label_name":"precipitation","score":5.28}],"status":"ok"};
        fn(response.data);

        /*
        var url = this.server + "/data_sets/search?query=" +
          encodeURIComponent(term);
        this._getResource({
          url: url,
          onLoad: function(e) {
            var list = JSON.parse(e.target.responseText);
            var vlist = list.data;
            fn(vlist);
          },
          onError: function() {
            console.log("Cannot search for variables");
          }
        });
        */
      }

      getVariableData(standard_name, fn) {
        var response = {"head":{"vars":["variable_id","standardName","dataset","md5hash","start_time","end_time","boundary"]},"results":{"bindings":[{"boundary":{"datatype":"http://www.opengis.net/ont/geosparql#wktLiteral","type":"literal","value":"<http://www.opengis.net/def/crs/OGC/1.3/CRS84> POLYGON ((41.239706 -95.620333, 41.239706 -95.594684, 41.225164 -95.594684, 41.225164 -95.620333, 41.239706 -95.620333))"},"dataset":{"type":"uri","value":"https://mint.isi.edu/dcat/datasets/Treynor---Iowa-30m_June_07_67"},"end_time":{"datatype":"http://www.w3.org/2001/XMLSchema#dateTime","type":"literal","value":"2012-06-07T23:59:59"},"md5hash":{"type":"literal","value":"44c29edb103a2872f519ad0c9a0fdaaa"},"standardName":{"type":"uri","value":"http://www.geoscienceontology.org/geo-lower/atmosphere_water__precipitation_leq-volume_flux"},"start_time":{"datatype":"http://www.w3.org/2001/XMLSchema#dateTime","type":"literal","value":"2012-06-07T00:00:00"},"variable_id":{"type":"uri","value":"https://mint.isi.edu/dcat/variables/atmosphere_water__precipitation_leq-volume_flux?file_location=d771fe71dca94eb1513c4523dd92b843&time_range=2012-06-07T00%3A00%3A00%2F2012-06-07T23%3A59%3A59&spatial_coverage=b317cfc4f7877ec30e2a4afd23c431a2&short_name=P"}}]}};
        fn(response.results.bindings);
        /*
        var url = this.server + "/data_sets?standard_name=" +
          encodeURIComponent(standard_name);
        this._getResource({
          url: url,
          onLoad: function(e) {
            var metalist = JSON.parse(e.target.responseText);
            var blist = metalist.results.bindings;
            fn(blist);
          },
          onError: function() {
            console.log("Cannot fetch files info");
          }
        });*/
      }

      getVariableFiles(standard_name, fn) {
        var files = [];
        var me = this;
        this.getVariableData(standard_name, function(blist) {
          var num=0;
          for(let i=0; i<blist.length; i++) {
            let binding = blist[i];
            files.push(binding);
            // console.log(binding);
            let bid = binding.variable_id.value;
            me.getDatasetLocation(bid, function(bindings) {
              num++;
              binding.plan = bindings;
              if(num == blist.length) {
                fn(files);
              }
            });
          }
          if(blist.length == 0)
            fn(null);
        });
      }

      getDatasetLocation(vid, fn) {
        var me = this;
        var data = {variable_id: vid};
        /*
        me._postResource({
          url: me.server + "/data_sets/get_location_url",
          onLoad: function(e) {
            var bdata = JSON.parse(e.target.responseText);
            var bindings = bdata.results.bindings;
            fn(bindings);
          },
          onError: function() {
            console.log("Cannot fetch file location");
          }
        }, JSON.stringify(data));*/
      }

      getBindingsForVariables(variables, fn) {
        var me = this;
        var variable_bindings = {};
        var num = 0;
        for(var i=0; i<variables.length; i++) {
          let v = variables[i];
          this.getVariableFiles(v, function(bindings) {
            num++;
            if(bindings)
              variable_bindings[v] = bindings;
            if(num==variables.length)
              fn(variable_bindings);
          });
        }
      }

      _getResource(rq) {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener('load', rq.onLoad.bind(this));
        xhr.addEventListener('error', rq.onError.bind(this));
        //xhr.withCredentials = true;
        xhr.open('GET', rq.url);
        xhr.send();
      }

      _postResource(rq, data) {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener('load', rq.onLoad.bind(this));
        xhr.addEventListener('error', rq.onError.bind(this));
        //xhr.withCredentials = true;
        xhr.open('POST', rq.url);
        xhr.setRequestHeader("Content-type", "application/json");
        xhr.send(data);
      }
    }
    customElements.define(MintDataCatalog.is, MintDataCatalog);

  </script>

</dom-module>
