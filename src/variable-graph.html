<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu-light.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/polymer/lib/utils/render-status.html">
<link rel="import" href="d3-import.html">
<link rel="import" href="mint-component-library.html">

<script src="../js/gui/template/common.js"></script>
<script src="../js/gui/vgraph/graph-variable.js"></script>
<script src="../js/gui/vgraph/graph-link.js"></script>
<script src="../js/gui/vgraph/graph-layout.js"></script>
<script src="../js/gui/vgraph/graph-item-config.js"></script>
<script src="../js/gui/vgraph/graph-events.js"></script>
<script src="../js/gui/vgraph/variable-graph.js"></script>

<dom-module id="variable-graph">
  <template>
    <style>
      :host {
        display: block;
      }
      .outer {
        width:100%;
        height: 400px;
        overflow: auto;
        border: 2px solid var(--app-accent-color);
        border-width:0px 2px;
      }
      .toolbar {
        color:white;
        width:100%;
        background-color: var(--app-accent-color);
        border: 2px solid var(--app-accent-color);
        border-radius: 4px 4px 0px 0px;
        @apply --layout-horizontal;
        @apply --layout-wrap;
        @apply --layout-center-justified;
      }
      .bottom {
        border-radius: 0px 0px 4px 4px;
      }
      paper-toggle-button {
        --paper-toggle-button-checked-button-color:  white;
        --paper-toggle-button-unchecked-button-color:  var(--app-accent-color);
        --paper-toggle-button-label-color:  white;
      }
      .toolbar paper-button {
        min-width:32px;
      }
      .toolbar paper-button, .toolbar paper-icon-button {
        max-height: 36px;
      }
      #canvas {
        width:100%;
        height:100%;
      }
      paper-input, paper-dropdown-menu-light {
        margin:0px;
        width: calc(100% - 50px);
        --paper-input-container: {
          padding: 2px 0px;
        }
      }
      paper-dialog {
        width:400px;
        max-width: 80%;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        background-color: white;
        border: 2px solid var(--app-accent-color);
        border-radius: 4px;
      }
      .heading {
        margin:0px;
        padding-top:4px;
        margin-bottom:8px;
        font-size:1.2em;
        background-color: var(--app-accent-color);
        color:white;
      }
      paper-item {
        min-height: 32px;
      }
      paper-button.delete {
        float:left;
        color: var(--paper-red-500);
      }
      paper-button.delete:hover {
        background-color: var(--paper-red-400);
        color:white;
      }
      div.grow {
        flex-grow:2;
      }
    </style>

    <!-- Top Toolbar -->
    <div class="toolbar">
      <paper-button on-click="save">Save</paper-button>
      <paper-button on-click="layout">Layout</paper-button>
      <template is="dom-if" if="[[editable]]">
        <paper-button on-click="analyze">Analyze</paper-button>
      </template>
    </div>

    <!-- Variable Graph Canvas -->
    <div class="outer">
      <div id="canvas"></div>
    </div>

    <!-- Bottom Toolbar -->
    <div class="toolbar bottom">
      <paper-button on-click="zoomIn">+</paper-button>
      <paper-button on-click="zoomOut">-</paper-button>
      <paper-toggle-button on-checked-changed="toggleView">STANDARD NAMES</paper-toggle-button>
    </div>

    <!-- Component Library -->
    <mint-component-library components="{{components}}" id="component_library"></mint-component-library>

    <!-- Edit/Add Variable Dialog -->
    <paper-dialog modal id="variable_editor" on-iron-overlay-closed="_editVariable">
      <div class='heading'>Edit Variable</div>
      <paper-input label="Variable Name" value="{{ed_item.name}}"></paper-input>
      <paper-input label="Standard Name" value="{{ed_item.standard_name}}"></paper-input>
      <paper-dropdown-menu-light no-animations label="Category">
        <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{ed_item.category}}">
          <paper-item value="">None</paper-item>
          <paper-item value="climate">Climate</paper-item>
          <paper-item value="hydrology">Hydrology</paper-item>
          <paper-item value="agronomy">Agronomy</paper-item>
          <paper-item value="economics">Economics</paper-item>
        </paper-listbox>
      </paper-dropdown-menu-light>
      <div class="buttons">
        <paper-button on-click="_deleteVariable" class="delete">Delete</paper-button>
        <div class="grow">&nbsp;</div>
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Submit</paper-button>
      </div>
    </paper-dialog>

    <!-- Temporary dialog to display graph json (no Saving for now) -->
    <paper-dialog id="save_display">
      <paper-dialog-scrollable>
        <paper-textarea label="Graph JSON" readonly value="[[graph_json]]"></paper-textarea>
      </paper-dialog-scrollable>
    </paper-dialog>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class VariableVGraph extends Polymer.Element {
      static get is() {
        return 'variable-graph';
      }

      static get properties() {
        var me = this;
        return {
          data: {
            type: Object
          },
          workflows: {
            type: Array,
            notify: true
          },
          editable: Boolean,
          autoLayout: Boolean,
          autoLoad: Boolean,
          width: {
            type: Number,
            value: 1280
          },
          height: {
            type: Number,
            value: 800
          },
          ed_item: Object,
          graph_json : String,
          components: Array
        };
      }

      static get observers() {
        return [
          // Observer method name, followed by a list of dependencies, in parenthesis
          '_variablesEdited(data.variables.*)',
          '_linksAddedOrRemoved(data.links.splices)',
          '_dataChanged(data)'
        ]
      }

      ready() {
        super.ready();
        this.variable_editor = this.$.variable_editor;
      }

      zoomIn() {
        this.graph.zoom(1.2, false);
      }

      zoomOut() {
        this.graph.zoom(1.0/1.2, false);
      }

      layout() {
        this.graph.layout(true);
      }

      resetSize() {
      }

      save() {
        this.graph.savePositions();
        this.graph_json = JSON.stringify(this.data, null, 2);
        this.$.save_display.open();
        //TODO: Save on server
      }

      toggleView(d) {
        if(this.graph)
          this.graph.switchText(d.detail.value);
      }

      analyze() {
        var clib = this.$.component_library;
        this.set("workflows", clib.solve(this.data));
      }

      _dataChanged(data, old) {
        if (!data)
          return;

        if(this.autoLoad)
          this.loadGraph();
      }

      loadGraph() {
        this.id = this.data.id;
        this.graph = new VGraph(this.id, this.data, this);
        this.graph.setEditable(this.editable);
        this.graph.draw(this.$.canvas);
        this.set("workflows", []);
        if(this.autoLayout)
          this.graph.layout();
        this.graph.zoom(1);
      }

      selectVariables(items) {
        this.graph.events.deselectAllItems();
        for(var i=0; i<items.length; i++) {
          var itemid = items[i];
          if (itemid in this.graph.variables)
            this.graph.events.selectItem(this.graph.variables[itemid]);
        }
      }

      _editVariable(e) {
        if(e.detail.confirmed) {
          // Check if existing edited
          for (var i=0; i<this.data.variables.length; i++) {
            if(this.data.variables[i].id == this.ed_item.id) {
              this.set("data.variables."+i, this.ed_item);
              return;
            }
          }
          // New Variable
          this.graph.editor.push("data.variables", this.ed_item);
        }
      }

      _deleteVariable() {
        for (var i=0; i<this.data.variables.length; i++) {
          if(this.data.variables[i].id == this.ed_item.id) {
            this.splice("data.variables", i, 1);
            this.ed_item = null;
            break;
          }
        }
        this.variable_editor.close();
      }

      _variablesEdited(data) {
        var v = data.value;
        if(v && !Array.isArray(v)) {
          if(v.indexSplices) {
            this._variablesAddedOrRemoved(v);
          }
          else if(v.id in this.graph.variables) {
            // Update
            this.graph.variables[v.id].setText(v.name);
            this.graph.variables[v.id].alternate_text = v.standard_name;
            this.graph.variables[v.id].config.setCategory(v.category);
            this.graph.variables[v.id].draw();
          }
        }
      }

      _variablesAddedOrRemoved(changeRecord) {
        if (changeRecord) {
          changeRecord.indexSplices.forEach(function(s) {
            s.removed.forEach(function(variable) {
              this.graph.removeVariable(variable);
            }, this);
            for (var i = 0; i < s.addedCount; i++) {
              var index = s.index + i;
              var newVariable = s.object[index];
              this.graph.addVariable(newVariable, true);
            }
          }, this);
        }
      }

      _linksAddedOrRemoved(changeRecord) {
        if (changeRecord) {
          changeRecord.indexSplices.forEach(function(s) {
            s.removed.forEach(function(link) {
              //console.log(link.name + ' was removed');
            });
            for (var i = 0; i < s.addedCount; i++) {
              var index = s.index + i;
              var newLink = s.object[index];
              this.graph.addLink(newLink);
            }
          }, this);
        }
      }

    }

    window.customElements.define(VariableVGraph.is, VariableVGraph);
  </script>
</dom-module>
